<!DOCTYPE html>
<html lang="eus">
<head>
  <script>
    // Traducciones para el menú lateral
    const menuTranslations = {
      es: { plantilla: 'Plantilla', once: 'Crear once' },
      eu: { plantilla: 'Taldea', once: 'Hamaikakoa sortu'}
    };
    let menuLang = 'es';
    // Leer idioma guardado en localStorage si existe
    if (localStorage.getItem('lang')) {
      menuLang = localStorage.getItem('lang');
    }
  </script>
  <meta charset="UTF-8">
  <title>Hamaikakoa</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    .sidebar {
      position: fixed;
      top: 0;
      left: 0;
      width: 210px;
      height: 100vh;
      background: #002244;
      color: #fff;
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      padding-top: 48px;
      z-index: 100;
      box-shadow: 2px 0 12px rgba(0,0,0,0.08);
    }
    .sidebar a {
      color: #fff;
      text-decoration: none;
      font-size: 1.2em;
      font-weight: bold;
      padding: 16px 32px;
      width: 100%;
      display: block;
      border-left: 4px solid transparent;
      transition: background 0.15s, border-color 0.15s;
    }
    .sidebar a.active, .sidebar a:hover {
      background: #003366;
      border-left: 4px solid #0077cc;
    }
    .main-content {
      margin-left: 210px;
      padding: 0;
    }
    @media (max-width: 900px) {
      .sidebar { width: 56px; padding-top: 24px; }
      .sidebar a { font-size: 1em; padding: 12px 8px; }
      .main-content { margin-left: 56px; }
    }
  </style>
  <style>
  body { font-family: Arial, sans-serif; background: #003366; margin: 0; padding: 0; }
    .field-container {
      position: relative;
      width: 650px;
      height: 764px;
      margin: 40px auto 16px auto;
      background: #fff;
      border-radius: 24px;
      box-shadow: 0 2px 16px rgba(0,0,0,0.18);
      overflow: hidden;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }
    .field-img {
  width: 100%;
  height: 100%;
  object-fit: cover;
  position: relative;
  z-index: 1;
    }
    .player-pos {
      position: absolute;
      width: 110px;
      height: 110px;
      border-radius: 50%;
      background: rgba(255,255,255,0.95);
      box-shadow: 0 2px 8px rgba(0,0,0,0.12);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      z-index: 2;
      transition: box-shadow 0.2s, width 0.2s, height 0.2s;
    }
    .player-pos.selected {
      width: 130px;
      height: 130px;
      box-shadow: 0 6px 24px rgba(0,0,0,0.22);
    }
    .player-pos:hover {
      box-shadow: 0 4px 16px rgba(0,0,0,0.22);
    }
    .player-img {
  width: 100%;
  height: 100%;
  border-radius: 50%;
  object-fit: cover;
  background: #eee;
  border: 2px solid #0077cc;
    }
    .plus-icon {
      font-size: 3em;
      color: #0077cc;
      font-weight: bold;
      user-select: none;
    }
    .player-list-modal {
      position: fixed;
      top: 0; left: 0; width: 100vw; height: 100vh;
      background: rgba(0,0,0,0.45);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10;
    }
    .player-list-box {
      background: #fff;
      border-radius: 16px;
      padding: 32px 24px;
      max-width: 420px;
      max-height: 80vh;
      overflow-y: auto;
      box-shadow: 0 2px 16px rgba(0,0,0,0.18);
    }
    .player-list-box h3 { margin-top: 0; }
    .player-list-item {
      display: flex;
      align-items: center;
      gap: 16px;
      padding: 10px 0;
      border-bottom: 1px solid #eee;
      cursor: pointer;
      transition: background 0.15s;
    }
    .player-list-item:hover {
      background: #f0f8ff;
    }
    .player-list-img {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      object-fit: cover;
      background: #eee;
      border: 1px solid #0077cc;
    }
    .player-list-name {
      font-size: 1.1em;
      font-weight: bold;
      color: #222;
    }
    .player-list-dorsal {
      font-size: 1em;
      color: #0077cc;
      font-weight: bold;
      margin-right: 8px;
    }
    .close-modal-btn {
      background: #e74c3c;
      color: #fff;
      border: none;
      border-radius: 8px;
      padding: 8px 18px;
      font-size: 1em;
      cursor: pointer;
      margin-top: 18px;
      float: right;
    }
    #optionsBlock {
      width: 100%;
      flex-wrap: wrap;
      gap: 32px;
      margin-top: 32px;
      margin-bottom: 24px;
      text-align: center;
      background: none;
      position: static !important;
      z-index: 2;
      justify-content: center;
    }
    #optionsBlock > div {
      margin-bottom: 20px !important;
      justify-content: center;
    }
    @media (max-width: 700px) {
      #optionsBlock {
        flex-direction: column;
        align-items: center;
        text-align: center;
        gap: 32px;
      }
      #optionsBlock > div {
        margin-bottom: 24px !important;
        justify-content: center;
      }
      .field-container {
    width: 98vw;
    height: 120vw;
    min-width: 0;
    min-height: 0;
    margin: 16px auto 8px auto;
    border-radius: 16px;
  }
  .field-img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }
  .player-pos {
    width: 16vw;
    height: 16vw;
    min-width: 60px;
    min-height: 60px;
    max-width: 90px;
    max-height: 90px;
  }
  .player-pos.selected {
    width: 19vw;
    height: 19vw;
    min-width: 70px;
    min-height: 70px;
    max-width: 110px;
    max-height: 110px;
  }
  #optionsContainer {
    display: block;
    margin-top: 24px;
    margin-bottom: 0;
  }
  #filterContainer {
    position: static !important;
    display: block;
    margin: 0 auto 0 auto;
    right: auto !important;
    top: auto !important;
    text-align: center;
    width: 100vw;
    max-width: 100vw;
    z-index: 2;
  }
  #langSwitch {
    right: 8vw !important;
    top: 2vw !important;
  }
  #downloadBtn, #clearBtn {
    min-width: 120px;
    font-size: 1.1em;
    padding: 12px 18px;
  }
  .player-list-box {
    max-width: 96vw;
    padding: 18px 8px;
  }
  .player-list-img {
    width: 36px;
    height: 36px;
  }
}
  </style>
</head>
<body>
  <div class="sidebar">
    <a href="plantilla.html" id="menu-plantilla">Taldea</a>
    <a href="hamaikakoa.html" id="menu-once" class="active">Hamaikakoa sortu</a>
  </div>
  <div class="main-content">
    <div style="position:relative;">
      <div id="langSwitch" style="position:absolute; top:18px; right:24px;">
        <button id="langBtn" style="background:#fff; color:#003366; border-radius:8px; border:none; font-weight:bold; font-size:1em; padding:6px 18px; cursor:pointer; box-shadow:0 2px 8px rgba(0,0,0,0.12);">Eus</button>
      </div>
    </div>
    <!-- Opciones: formación, filtro, marca de agua -->
    <div id="optionsBlock" class="d-flex flex-wrap align-items-center justify-content-center gap-4 mb-4" style="margin-top:32px;">
  <div class="d-flex align-items-center flex-wrap justify-content-center" style="margin-bottom:20px;">
    <label id="formationLabel" class="form-label mb-0 me-2" style="color:#fff; font-size:1.2em; font-weight:bold;">
      <span id="formationText">Formación:</span>
    </label>
  <select id="formationSelect" class="form-select w-auto" style="font-size:1em; padding:4px 12px; border-radius:6px; border:none; min-width:120px; max-width:120px;">
  <option value="4-3-3">4-3-3</option>
  <option value="4-2-3-1">4-2-3-1</option>
  <option value="4-4-2 (1)">4-4-2 (1)</option>
  <option value="4-4-2 (2)">4-4-2 (2)</option>
  <option value="5-3-2">5-3-2</option>
  <option value="5-2-3">5-2-3</option>
  <option value="5-1-3-1">5-1-3-1</option>
  <option value="4-5-1">4-5-1</option>
  <option value="4-2-1-2-1">4-2-1-2-1</option>
    </select>
  </div>
  <div class="d-flex align-items-center flex-wrap justify-content-center" style="margin-bottom:20px;">
    <input type="checkbox" id="filterByPosition" checked class="form-check-input me-2" style="transform:scale(1.3); vertical-align:middle;">
    <label id="filterLabel" for="filterByPosition" class="form-label mb-0" style="color:#fff; font-size:1.2em; font-weight:bold;">
      <span id="filterText">Jokalariak postuarekiko filtratu</span>
    </label>
  </div>
</div>
<div class="field-container" style="margin-top:32px;">
  <img class="field-img" src="https://raw.githubusercontent.com/OriyokoIjitua/TwReal/main/img/Zelaia.jpg" alt="Campo">
  <!-- Posiciones de jugadores -->
  <div id="positions"></div>
</div>
<!-- Botones de descargar y limpiar -->
<div style="text-align:center; margin-bottom:32px;">
  <div class="d-flex flex-column flex-md-row justify-content-center align-items-center gap-3">
    <button id="downloadBtn" class="btn btn-primary" style="min-width:170px; font-size:1.4em;">Jaitsi</button>
    <button id="clearBtn" class="btn btn-primary" style="min-width:170px; font-size:1.4em;">Garbitu</button>
  </div>
</div>
<div id="playerListModal" class="player-list-modal" style="display:none;">
    <div class="player-list-box">
      <h3>Jokalaria aukeratu</h3>
      <div id="playerList"></div>
      <button class="close-modal-btn" onclick="closePlayerList()">Itxi</button>
    </div>
  </div>
  <script>
    // Traducciones
    const translations = {
      es: {
        filter: 'Filtrar jugadores por posición',
        descargar: 'Descargar',
        limpiar: 'Limpiar',
        seleccionaJugador: 'Selecciona jugador',
        cerrar: 'Cerrar',
        formacion: 'Formación:',
        menuOnce: 'Crear once',
        menuPlantilla: 'Plantilla'
      },
      eu: {
        filter: 'Jokalariak postuarekiko filtratu',
        descargar: 'Jaitsi',
        limpiar: 'Garbitu',
        seleccionaJugador: 'Jokalaria aukeratu',
        cerrar: 'Itxi',
        formacion: 'Formazioa:',
        menuOnce: 'Hamaikakoa sortu',
        menuPlantilla: 'Taldea'
      }
    };
    // Idioma actual
    let currentLang = 'es';
  // Sincronizar idioma principal con menú
  currentLang = menuLang;
    // Centraliza la actualización de textos UI y menú
    function updateUI() {
      // Textos principales
      document.getElementById('filterText').textContent = translations[currentLang].filter;
      document.getElementById('downloadBtn').textContent = translations[currentLang].descargar;
      document.getElementById('clearBtn').textContent = translations[currentLang].limpiar;
      const modalTitle = document.querySelector('.player-list-box h3');
      if (modalTitle) modalTitle.textContent = translations[currentLang].seleccionaJugador;
      const closeBtn = document.querySelector('.close-modal-btn');
      if (closeBtn) closeBtn.textContent = translations[currentLang].cerrar;
      document.getElementById('formationText').textContent = translations[currentLang].formacion;
      // Menú lateral (usa menuTranslations para mantener consistencia con el menú del encabezado)
      document.getElementById('menu-once').textContent = menuTranslations[currentLang].once;
      document.getElementById('menu-plantilla').textContent = menuTranslations[currentLang].plantilla;
      const btn = document.getElementById('langBtn');
      if (btn) btn.textContent = currentLang === 'es' ? 'Eus' : 'Cast';
      // Móvil
      if (document.getElementById('filterLabelMobile'))
        document.getElementById('filterLabelMobile').childNodes[2].textContent = translations[currentLang].filter;
      if (document.getElementById('formationTextMobile'))
        document.getElementById('formationTextMobile').textContent = translations[currentLang].formacion;
    }

    // Botón de idioma: alterna currentLang y guarda en localStorage
    document.getElementById('langBtn').onclick = function() {
      currentLang = currentLang === 'es' ? 'eu' : 'es';
      localStorage.setItem('lang', currentLang);
      updateUI();
    };
    // Inicializar UI
    updateUI();
    // Lista de jugadores: se leerá exactamente igual que en `plantilla.html`
    let players = [];
    const IMG_ROOT = 'https://raw.githubusercontent.com/OriyokoIjitua/TwReal/main/img/';

    // Cargar datos por temporada desde el JSON en raw.githubusercontent (igual que plantilla.html)
    async function cargarDatosTemporada(temporada) {
      try {
        const data = await fetch(`https://raw.githubusercontent.com/OriyokoIjitua/TwReal/main/temporadas/plantilla_${temporada}.json`).then(r => {
          if (!r.ok) throw new Error('HTTP ' + r.status);
          return r.json();
        });
        const jugadoresData = data.filter(ind => ind.tipo === 'jugador');
        players = jugadoresData.map(p => ({
          dorsal: p.dorsal,
          name: p.name,
          url_name: p.url_name,
          img: IMG_ROOT + temporada + '/' + (p.url_name || '').trim() + '.jpg',
          positions: Array.isArray(p.positions) ? p.positions : (p.positions ? [p.positions] : [] ),
          fullname: p.fullname,
          pais: p.pais,
          pais2: p.pais2,
          pos: p.pos,
          cancion: p.cancion
        }));
        renderPositions();
      } catch (err) {
        console.error('Error cargando plantilla_' + temporada + '.json:', err);
        showLoadError('No se ha podido cargar el JSON de plantilla para la temporada ' + temporada + '. Comprueba la conexión o sirve los archivos vía HTTP.');
      }
    }

    // Cargar la temporada por defecto (igual que plantilla.html)
    cargarDatosTemporada('2025-26');

    // Definición de formaciones
    const formations = {
      '4-3-3': [
        { x: 60, y: 60, role: 'EI' }, // Extremo Izq
        { x: 260, y: 20, role: 'DC' }, // Delantero Centro
        { x: 460, y: 60, role: 'ED' }, // Extremo Der
        { x: 360, y: 190, role: 'MCO' }, // Mediopunta der
        { x: 160, y: 210, role: 'MC' }, // Mediocentro izq
        { x: 260, y: 310, role: 'MCD' }, // Pivote
        { x: 180, y: 470, role: 'DFC' }, // Central Izq
        { x: 340, y: 470, role: 'DFC' }, // Central Der
        { x: 35, y: 420, role: 'LI' }, // Lateral Izq
        { x: 485, y: 420, role: 'LD' }, // Lateral Der
        { x: 260, y: 600, role: 'POR' }
      ],
      '4-2-3-1': [
        { x: 60, y: 100, role: 'EI' }, // Extremo Izq
        { x: 260, y: 20, role: 'DC' }, // Delantero Centro
        { x: 460, y: 100, role: 'ED' }, // Extremo Der
        { x: 260, y: 190, role: 'MCO' }, // Mediopunta
        { x: 160, y: 310, role: 'MCD' }, // Pivote izq
        { x: 360, y: 310, role: 'MCD' }, // Pivote der
        { x: 180, y: 470, role: 'DFC' }, // Central Izq
        { x: 340, y: 470, role: 'DFC' }, // Central Der
        { x: 35, y: 420, role: 'LI' }, // Lateral Izq
        { x: 485, y: 420, role: 'LD' }, // Lateral Der
        { x: 260, y: 600, role: 'POR' }
      ],
      '4-4-2 (1)': [
        { x: 160, y: 40, role: 'DC' }, // Delantero Izq
        { x: 360, y: 40, role: 'DC' }, // Delantero Der
        { x: 420, y: 190, role: 'MCO' }, // Mediopunta der
        { x: 100, y: 190, role: 'MC' }, // Mediocentro izq
        { x: 190, y: 310, role: 'MCD' }, // Pivote izq
        { x: 330, y: 310, role: 'MCD' }, // Pivote der
        { x: 180, y: 470, role: 'DFC' }, // Central Izq
        { x: 340, y: 470, role: 'DFC' }, // Central Der
        { x: 35, y: 420, role: 'LI' }, // Lateral Izq
        { x: 485, y: 420, role: 'LD' }, // Lateral Der
        { x: 260, y: 600, role: 'POR' }
      ],
      '4-4-2 (2)': [
        { x: 160, y: 40, role: 'DC' }, // Delantero Izq
        { x: 360, y: 40, role: 'DC' }, // Delantero Der
        { x: 260, y: 160, role: 'MCO' }, // Mediopunta
        { x: 100, y: 220, role: 'MC' }, // MC izq
        { x: 420, y: 220, role: 'MC' }, // MC der
        { x: 260, y: 320, role: 'MCD' }, // Pivote
        { x: 180, y: 470, role: 'DFC' }, // Central Izq
        { x: 340, y: 470, role: 'DFC' }, // Central Der
        { x: 35, y: 420, role: 'LI' }, // Lateral Izq
        { x: 485, y: 420, role: 'LD' }, // Lateral Der
        { x: 260, y: 600, role: 'POR' }
      ],
      '5-3-2': [
        { x: 160, y: 40, role: 'DC' }, // Delantero Izq
        { x: 360, y: 40, role: 'DC' }, // Delantero Der
        { x: 380, y: 180, role: 'MCO' }, // Mediopunta der
        { x: 140, y: 200, role: 'MC' }, // Mediocentro izq
        { x: 260, y: 300, role: 'MCD' }, // Pivote
        { x: 260, y: 440, role: 'DFC' }, // Central
        { x: 120, y: 490, role: 'DFC' }, // Central Izq
        { x: 400, y: 490, role: 'DFC' }, // Central Der
        { x: 35, y: 370, role: 'LI' }, // Lateral Izq
        { x: 485, y: 370, role: 'LD' }, // Lateral Der
        { x: 260, y: 600, role: 'POR' }
      ],
      '5-2-3': [
        { x: 60, y: 120, role: 'EI' }, // Extremo Izq
        { x: 260, y: 20, role: 'DC' }, // Delantero Centro
        { x: 460, y: 120, role: 'ED' }, // Extremo Der
        { x: 360, y: 250, role: 'MC' }, // Mediocentro der
        { x: 160, y: 280, role: 'MCD' }, // Pivote izq
        { x: 260, y: 440, role: 'DFC' }, // Central
        { x: 120, y: 490, role: 'DFC' }, // Central Izq
        { x: 400, y: 490, role: 'DFC' }, // Central Der
        { x: 35, y: 370, role: 'LI' }, // Lateral Izq
        { x: 485, y: 370, role: 'LD' }, // Lateral Der
        { x: 260, y: 600, role: 'POR' }
      ],
      '5-1-3-1': [
        { x: 60, y: 120, role: 'EI' }, // Extremo Izq
        { x: 260, y: 20, role: 'DC' }, // Delantero Centro
        { x: 460, y: 120, role: 'ED' }, // Extremo Der
        { x: 260, y: 170, role: 'MCO' }, // Mediapunta
        { x: 260, y: 310, role: 'MCD' }, // Pivote
        { x: 260, y: 440, role: 'DFC' }, // Central
        { x: 120, y: 490, role: 'DFC' }, // Central Izq
        { x: 400, y: 490, role: 'DFC' }, // Central Der
        { x: 35, y: 370, role: 'LI' }, // Lateral Izq
        { x: 485, y: 370, role: 'LD' }, // Lateral Der
        { x: 260, y: 600, role: 'POR' }
      ],
      '4-5-1': [
        { x: 50, y: 140, role: 'MCO' }, // Centro izquierdo
        { x: 260, y: 20, role: 'DC' }, // Delantero Centro
        { x: 470, y: 140, role: 'MCO' }, // Centro derecho
        { x: 160, y: 240, role: 'MC' }, // Pivote izq
        { x: 360, y: 240, role: 'MC' }, // Pivote der
        { x: 260, y: 340, role: 'MCD' }, // Medio
        { x: 180, y: 470, role: 'DFC' }, // Central Izq
        { x: 340, y: 470, role: 'DFC' }, // Central Der
        { x: 35, y: 400, role: 'LI' }, // Lateral Izq
        { x: 485, y: 400, role: 'LD' }, // Lateral Der
        { x: 260, y: 600, role: 'POR' }
      ],
      '4-2-1-2-1': [
        { x: 100, y: 150, role: 'MCO' }, // Centro izquierdo
        { x: 260, y: 20, role: 'DC' }, // Delantero Centro
        { x: 420, y: 150, role: 'MCO' }, // Centro derecho
        { x: 260, y: 190, role: 'MC' }, // Medio
        { x: 160, y: 310, role: 'MCD' }, // Pivote izq
        { x: 360, y: 310, role: 'MCD' }, // Pivote der
        { x: 180, y: 470, role: 'DFC' }, // Central Izq
        { x: 340, y: 470, role: 'DFC' }, // Central Der
        { x: 35, y: 400, role: 'LI' }, // Lateral Izq
        { x: 485, y: 400, role: 'LD' }, // Lateral Der
        { x: 260, y: 600, role: 'POR' }
      ]
    };

  // Inicializar formación según el selector
  let currentFormation = document.getElementById('formationSelect').value || '4-3-3';
  let positions = formations[currentFormation];

    // Estado de jugadores asignados
    let assigned = Array(positions.length).fill(null);

    // Cambiar formación y mantener jugadores
    document.getElementById('formationSelect').addEventListener('change', function() {
      const prevFormation = currentFormation;
      const newFormation = this.value;
      if (newFormation === prevFormation) return;
      // Mapear roles equivalentes
      const prevPositions = formations[prevFormation];
      const nextPositions = formations[newFormation];
      let newAssigned = Array(nextPositions.length).fill(null);

      newAssigned[0] = assigned[0];
      newAssigned[1] = assigned[1];
      newAssigned[2] = assigned[2];
      newAssigned[3] = assigned[3];
      newAssigned[4] = assigned[4];
      newAssigned[5] = assigned[5];
      newAssigned[6] = assigned[6];
      newAssigned[7] = assigned[7];
      newAssigned[8] = assigned[8];
      newAssigned[9] = assigned[9];
      newAssigned[10] = assigned[10];
  currentFormation = newFormation;
  positions = formations[currentFormation];
  assigned = newAssigned;
  renderPositions();
    });

    function renderPositions() {
      const container = document.getElementById('positions');
      container.innerHTML = '';
      positions.forEach((pos, idx) => {
        const div = document.createElement('div');
        div.className = 'player-pos' + (assigned[idx] ? ' selected' : '');
        // Centrar el círculo pequeño respecto al grande
        if (!assigned[idx]) {
          // player-pos: 110x110, player-pos.selected: 130x130
          // Centrar el círculo pequeño (110x110) respecto al grande (130x130)
          div.style.left = (pos.x + 10) + 'px';
          div.style.top = (pos.y + 10) + 'px';
        } else {
          div.style.left = pos.x + 'px';
          div.style.top = pos.y + 'px';
        }
        div.onclick = (e) => {
          e.stopPropagation();
          openPlayerList(idx);
        };
        // Menú contextual (click derecho)
        div.oncontextmenu = (e) => {
          e.preventDefault();
          if (!assigned[idx]) return;
          // Eliminar menú anterior si existe
          const oldMenu = document.getElementById('contextMenu');
          if (oldMenu) oldMenu.remove();
          // Crear menú
          const menu = document.createElement('div');
          menu.id = 'contextMenu';
          menu.style.position = 'fixed';
          menu.style.left = e.clientX + 'px';
          menu.style.top = e.clientY + 'px';
          menu.style.background = '#fff';
          menu.style.border = '1px solid #0077cc';
          menu.style.borderRadius = '8px';
          menu.style.boxShadow = '0 2px 12px rgba(0,0,0,0.18)';
          menu.style.zIndex = '9999';
          menu.style.padding = '8px 0';
          menu.style.minWidth = '160px';
          menu.style.fontSize = '1em';
          // Traducciones
          const lang = localStorage.getItem('lang') || 'es';
          const opts = [
            { es: 'Quitar jugador', eu: 'Jokalaria kendu', action: () => { assigned[idx] = null; if (window.cambiosOnce) delete window.cambiosOnce[idx]; renderPositions(); } },
            { es: 'Jugador suplente', eu: 'Ordezko jokalaria', action: () => { window.cambioEnPosicion = idx; openCambioList(idx); } }
          ];
    // Lista de jugadores para cambio
    function openCambioList(idx) {
      const modal = document.getElementById('playerListModal');
      modal.style.display = 'flex';
      const list = document.getElementById('playerList');
      list.innerHTML = '';
      // Actualizar título y botón cerrar según idioma
      const modalTitle = document.querySelector('.player-list-box h3');
      if (modalTitle) {
        modalTitle.textContent = (currentLang === 'eu') ? 'Ordezkoa aukeratu' : 'Selecciona el cambio';
      }
      const closeBtn = document.querySelector('.close-modal-btn');
      if (closeBtn) closeBtn.textContent = (currentLang === 'eu') ? 'Itxi' : 'Cerrar';
      const filterActive = document.getElementById('filterByPosition').checked;
      const posRole = positions[idx].role;
      const cambios = window.cambiosOnce || {};
      if (!Array.isArray(cambios[idx])) cambios[idx] = [];
      players.forEach(player => {
        if (filterActive && (!player.positions || !player.positions.includes(posRole))) return;
        const item = document.createElement('div');
        item.className = 'player-list-item';
        // ¿Ya seleccionado como suplente en esta posición?
        const isSelected = cambios[idx].includes(player.name);
        item.style.background = isSelected ? '#e0f7fa' : '';
        item.onclick = () => {
          // Si ya está como suplente en esta posición, quitarlo
          if (isSelected) {
            cambios[idx] = cambios[idx].filter(n => n !== player.name);
          } else {
            // Verificar si está como titular
            const getId = p => p ? (p.dorsal ? p.dorsal : p.name) : null;
            const playerId = getId(player);
            const titularIdx = assigned.findIndex(p => getId(p) === playerId);
            if (titularIdx !== -1) {
              // Si hay suplentes en la posición original, el primero pasa a titular
              if (Array.isArray(cambios[titularIdx]) && cambios[titularIdx].length > 0) {
                const nuevoTitular = cambios[titularIdx][0];
                const nuevoPlayer = players.find(p => p.name === nuevoTitular);
                assigned[titularIdx] = nuevoPlayer;
                // Eliminar ese suplente de la lista
                cambios[titularIdx] = cambios[titularIdx].filter(n => n !== nuevoTitular);
              } else {
                assigned[titularIdx] = null;
              }
              // Añadir el titular como suplente en la nueva posición
              cambios[idx].push(player.name);
              // Eliminar de suplentes en todas las posiciones
              Object.keys(cambios).forEach(k => {
                if (k != idx.toString()) cambios[k] = cambios[k].filter(n => n !== player.name);
              });
            } else {
              // Verificar si está como suplente en otra posición
              let foundIdx = null;
              Object.keys(cambios).forEach(k => {
                if (cambios[k].includes(player.name)) foundIdx = k;
              });
              if (foundIdx !== null && foundIdx != idx) {
                // Swap entre suplentes
                cambios[foundIdx] = cambios[foundIdx].filter(n => n !== player.name);
                cambios[idx].push(player.name);
              } else {
                cambios[idx].push(player.name);
              }
            }
          }
          window.cambiosOnce = cambios;
          modal.style.display = 'none';
          renderPositions();
        };
        item.innerHTML =
          '<span class="player-list-dorsal" style="display:inline-block;min-width:22px;max-width:22px;text-align:right;">' + (player.dorsal ? player.dorsal : '&nbsp;') + '</span>' +
          '<img class="player-list-img" src="' + player.img + '" />' +
          '<span class="player-list-name">' + player.name + '</span>';
        list.appendChild(item);
      });
    }
          opts.forEach(opt => {
            const btn = document.createElement('button');
            btn.textContent = opt[lang];
            btn.style.display = 'block';
            btn.style.width = '100%';
            btn.style.background = 'none';
            btn.style.border = 'none';
            btn.style.padding = '10px 18px';
            btn.style.textAlign = 'left';
            btn.style.cursor = 'pointer';
            btn.style.fontWeight = 'bold';
            btn.onmouseover = () => btn.style.background = '#f0f8ff';
            btn.onmouseout = () => btn.style.background = 'none';
            btn.onclick = () => {
              opt.action();
              menu.remove();
            };
            menu.appendChild(btn);
          });
          document.body.appendChild(menu);
          // Cerrar menú al hacer click fuera
          setTimeout(() => {
            document.addEventListener('click', function handler(ev) {
              if (!menu.contains(ev.target)) {
                menu.remove();
                document.removeEventListener('click', handler);
              }
            });
          }, 10);
        };
        if (assigned[idx]) {
          div.innerHTML = `
            <div style="position:relative;width:100%;height:100%;">
              <img class="player-img" src="${assigned[idx].img}" title="${assigned[idx].name} (${assigned[idx].dorsal})" />
              <div class="dorsal-badge-onfield" style="white-space:nowrap;overflow:hidden;text-overflow:ellipsis; font-size:0.8em;">
          ${assigned[idx].dorsal ?? ''}. ${assigned[idx].name}
              </div>
            </div>`;
        } else {
          div.innerHTML = '<span class="plus-icon">+</span>';
        }
        container.appendChild(div);
        // Mostrar nombres de todos los suplentes en líneas separadas debajo del círculo
        const cambios = window.cambiosOnce || {};
        if (Array.isArray(cambios[idx]) && cambios[idx].length > 0) {
          const cambioLabels = document.createElement('div');
          cambioLabels.style.position = 'absolute';
          cambioLabels.style.left = (pos.x + 11.5) + 'px';
          cambioLabels.style.top = (pos.y + 130) + 'px';
          cambioLabels.style.width = '110px';
          cambioLabels.style.pointerEvents = 'none';
          cambioLabels.style.zIndex = '10';
          cambioLabels.style.textAlign = 'center';
          cambioLabels.style.display = 'flex';
          cambioLabels.style.flexDirection = 'column';
          cambioLabels.style.gap = '2px';
          cambios[idx].forEach(nombre => {
            const cambioLabel = document.createElement('div');
            cambioLabel.textContent = nombre;
            cambioLabel.style.color = '#fff';
            cambioLabel.style.fontWeight = 'bold';
            cambioLabel.style.fontSize = '1em';
            cambioLabel.style.textShadow = '0 0 2px #0077cc, 0 0 2px #0077cc, 0 0 2px #0077cc';
            cambioLabels.appendChild(cambioLabel);
          });
          container.appendChild(cambioLabels);
        }
      });
    }

    function openPlayerList(idx) {
      const modal = document.getElementById('playerListModal');
      modal.style.display = 'flex';
      const list = document.getElementById('playerList');
      list.innerHTML = '';
      // Actualizar título y botón cerrar según idioma
      const modalTitle = document.querySelector('.player-list-box h3');
      if (modalTitle) modalTitle.textContent = translations[currentLang].seleccionaJugador;
      const closeBtn = document.querySelector('.close-modal-btn');
      if (closeBtn) closeBtn.textContent = translations[currentLang].cerrar;
      const filterActive = document.getElementById('filterByPosition').checked;
      const posRole = positions[idx].role;
      players.forEach(player => {
        if (filterActive && (!player.positions || !player.positions.includes(posRole))) return;
        const item = document.createElement('div');
        item.className = 'player-list-item';
        item.onclick = () => {
          // Identificador único: dorsal si existe, si no, nombre
          const getId = p => p ? (p.dorsal ? p.dorsal : p.name) : null;
          const playerId = getId(player);
          const cambios = window.cambiosOnce || {};
          // Eliminar al jugador de suplentes en todas las posiciones
          Object.keys(cambios).forEach(k => {
            cambios[k] = cambios[k].filter(n => n !== player.name);
          });
          const currentIdx = assigned.findIndex(p => getId(p) === playerId);
          if (currentIdx !== -1 && currentIdx !== idx) {
            const temp = assigned[idx];
            assigned[idx] = player;
            assigned[currentIdx] = temp;
            // Si hay suplentes en la posición original, el primero pasa a titular
            if (Array.isArray(cambios[currentIdx]) && cambios[currentIdx].length > 0) {
              const nuevoTitular = cambios[currentIdx][0];
              const nuevoPlayer = players.find(p => p.name === nuevoTitular);
              assigned[currentIdx] = nuevoPlayer;
              // Eliminar ese suplente de la lista
              cambios[currentIdx] = cambios[currentIdx].filter(n => n !== nuevoTitular);
              window.cambiosOnce = cambios;
            }
            // Si el jugador seleccionado era suplente en la nueva posición, el titular anterior pasa a suplente
            if (Array.isArray(cambios[idx]) && !cambios[idx].includes(temp?.name) && temp) {
              cambios[idx].push(temp.name);
              window.cambiosOnce = cambios;
            }
          } else {
            // Si el jugador seleccionado era suplente en la nueva posición, el titular anterior pasa a suplente
            const temp = assigned[idx];
            assigned[idx] = player;
            if (Array.isArray(cambios[idx]) && !cambios[idx].includes(temp?.name) && temp) {
              cambios[idx].push(temp.name);
              window.cambiosOnce = cambios;
            }
          }
          window.cambiosOnce = cambios;
          modal.style.display = 'none';
          renderPositions();
        };
        item.innerHTML =
          '<span class="player-list-dorsal" style="display:inline-block;min-width:22px;max-width:22px;text-align:right;">' + (player.dorsal ? player.dorsal : '&nbsp;') + '</span>' +
          '<img class="player-list-img" src="' + player.img + '" />' +
          '<span class="player-list-name">' + player.name + '</span>';
        list.appendChild(item);
      });
    // Actualizar lista de jugadores al cambiar el filtro
    document.getElementById('filterByPosition').addEventListener('change', () => {
      renderPositions();
    });
      // Cerrar modal al click fuera de la caja
      setTimeout(() => {
        modal.onclick = function(e) {
          if (e.target === modal) {
            modal.style.display = 'none';
          }
        };
      }, 50);
    }

    function closePlayerList() {
      document.getElementById('playerListModal').style.display = 'none';
    }

    // Descargar alineación como imagen
    function setupButtons() {
      document.getElementById('downloadBtn').onclick = function() {
        const field = document.querySelector('.field-container');
        if (window.html2canvas) {
          window.html2canvas(field, {
        backgroundColor: null,
        useCORS: true,
        scale: 2 // Mejora la calidad duplicando la resolución
      }).then(canvas => {
            const link = document.createElement('a');
            link.download = 'Hamaikakoa.jpg';
            link.href = canvas.toDataURL('image/jpeg', 0.98); // Calidad máxima
            link.click();
          });
        } else {
          alert('html2canvas no está cargado todavía. Espera unos segundos y vuelve a intentarlo.');
        }
      };
      document.getElementById('clearBtn').onclick = function() {
        assigned = Array(positions.length).fill(null);
        renderPositions();
      };
    }
    setupButtons();
    // Cargar html2canvas si no existe
    if (!window.html2canvas) {
      const script = document.createElement('script');
      script.src = 'https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js';
      script.onload = setupButtons;
      document.body.appendChild(script);
    }

    // Al cargar, sincronizar selector y formación
    document.addEventListener('DOMContentLoaded', function() {
      // Si el selector tiene valor, usarlo
      currentFormation = document.getElementById('formationSelect').value || '4-3-3';
      positions = formations[currentFormation];
      renderPositions();
    });
  </script>
  <style>
  .dorsal-badge-onfield {
    position: absolute;
    left: 0;
    bottom: 0;
    background: rgba(0,0,0,0.75);
    color: #fff;
    font-size: 1.05em;
    font-weight: bold;
    border-radius: 0 8px 0 12px;
    padding: 2px 10px 2px 8px;
    z-index: 3;
    min-width: 24px;
    text-align: left;
    box-shadow: 0 1px 4px rgba(0,0,0,0.18);
    letter-spacing: 1px;
    pointer-events: none;
  }
  </style>
</body>
</html>